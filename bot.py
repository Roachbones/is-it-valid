"""
This script uses the twitter API to post twitter polls with the questions
generated by question_generator.py.
"""

import json
import oauth2
from time import sleep
from urllib.parse import urlencode
from question_generator import generate

with open("secret_keys.txt", "r") as file:
    CONSUMER_KEY, CONSUMER_SECRET, ACCESS_KEY, ACCESS_SECRET = file.read().split("\n")

def oauth_req(url, http_method="POST", post_body="", http_headers=None):
    consumer = oauth2.Consumer(key=CONSUMER_KEY, secret=CONSUMER_SECRET)
    token = oauth2.Token(key=ACCESS_KEY, secret=ACCESS_SECRET)
    client = oauth2.Client(consumer, token)
    resp, content = client.request(url, method=http_method, body=post_body, headers=http_headers)
    return content

#the twitter API doesn't let us create polls,
#but we can attach pre-existing poll cards to our tweets.
#this card has yes/no answers and lasts 1 day.
POLL_CARD_URI = "card://1157768285603209219"

def post_question():
    status = generate()
    querystring = "?" + urlencode({"status":status, "card_uri":POLL_CARD_URI})
    response = json.loads(oauth_req("https://api.twitter.com/1.1/statuses/update.json" + querystring).decode("utf8"))
    assert not "errors" in response, reponse
    print("Posted question: '" + response["text"] + "' with tweet id: " + str(response["id"]))

SECONDS_BETWEEN_TWEETS = 23 * 60 * 60 #every 23 hours

while True:
    post_question()
    sleep(SECONDS_BETWEEN_TWEETS)
